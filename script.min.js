function EventEmitter() {
	this.events = {};
}

EventEmitter.prototype.on = function(event, listener) {
	if (typeof this.events[event] !== 'object') {
		this.events[event] = [];
	}

	this.events[event].push(listener);
}

EventEmitter.prototype.emit = function (event) {
	if (typeof this.events[event] !== 'object') return;
	var args = [].slice.call(arguments, 1)
	var listeners = this.events[event].slice(),
		length = listeners.length;
	for(var i = 0; i < length; i++) {
		listeners[i].apply(this, args)
	}
};

function App () {
	this.form = new Form(document.querySelector('.form-musician'));
	this.list = new List(document.querySelector('.musicians'));
	this.events = new EventEmitter();
	this.init();
}

App.prototype = {
	init: function () {
		this.form.on('enter-value', 		this.list.add.bind(this.list));
		this.form.on('select-unselect-all', this.list.selectUnselectAll.bind(this.list));
		this.form.on('remove-elements', 	this.list.remove.bind(this.list));

		this.list.on('check-for-del', 		this.form.checkDelBtn.bind(this.form));
		this.list.render(data);
	}
}

window.addEventListener('DOMContentLoaded', function(){
	new App();
});

var data = ['John Lennon', 'Gary Moore', 'Steve Vai', 'Ronnie James Dio'];

function List(el) {
	if (!el) return;
	this.events = new EventEmitter();
	this.el = el;
	this.ctrl = false;
	this.shif = false;
	this.shiftFromTo = [];
	this.init();
}

List.prototype = {
	init: function() {
		this.el.addEventListener('click', this.delegationEventClick.bind(this));
		document.addEventListener('keyup', this.delegationEventKeyup.bind(this));
		document.addEventListener('keydown', this.delegationEventKeydown.bind(this));
	},

	on: function (event, listener) {
		this.events.on(event, listener);
	},

	emit: function (event, parameters) {
		this.events.emit(event, parameters);
	},

	delegationEventClick: function (e) {
		var target = e.target;

		if (target.tagName === 'LI' && this.ctrl) {
			this.selectEl(target);
			this.shiftFromTo[0] = Array.prototype.indexOf.call(target.parentNode.children, target);
			
		} else if (target.tagName === 'LI' && this.shif) {
			this.shiftFromTo[1] = Array.prototype.indexOf.call(target.parentNode.children, target);

			var firstIndex = this.shiftFromTo[0];
			var lastIndex = this.shiftFromTo[1];
			
			firstIndex <= lastIndex 
				? this.selectElsFromTo(firstIndex, lastIndex) 
				: this.selectElsFromTo(lastIndex, firstIndex);
			
		} else if (target.tagName === 'LI') {
			this.selectOneEl(target)
			this.shiftFromTo[0] = Array.prototype.indexOf.call(target.parentNode.children, target);
		}

		this.checkForDel(this.getElForDel().length > 0);
	},

	delegationEventKeydown: function (e) {
		if (e.keyCode === 17) {
			this.ctrl = true;
		} else if (e.keyCode === 16) {
			this.shif = true;
		}
	},

	delegationEventKeyup: function (e) {
		if (e.keyCode === 17) {
			this.ctrl = false;
		} else if (e.keyCode === 16) {
			this.shif = false;
		}
	},

	add: function (text) {
		this.checkForDel(this.getElForDel().length !== 0);
		this.el.insertAdjacentHTML('beforeend', '<li>' + text + '</li>');
	},

	render: function (items) {
		for (var i = 0; i < items.length; i++) {
			this.add(items[i]);
		}
	},

	getElForDel: function () {
		return this.el.querySelectorAll('.for-del');
	},

	getAllEl: function () {
		return this.el.querySelectorAll('li');
	},

	selectAll: function () {
		var allEl = this.getAllEl();
		for (var i = 0; i < allEl.length; i++) {
			allEl[i].classList.add('for-del')
		}
	},

	unSelectAll: function () {
		var allEl = this.getAllEl();
		for (var i = 0; i < allEl.length; i++) {
			allEl[i].classList.remove('for-del');
		}
	},

	remove: function () {
		elements = this.getElForDel();
		for (var i = 0; i < elements.length; i++) {
			elements[i].parentNode.removeChild(elements[i]);
		}
	},

	selectUnselectAll: function () {
		this.getAllEl().length !== this.getElForDel().length ? this.selectAll() : this.unSelectAll();
		this.checkForDel(this.getElForDel().length !== 0);
	},

	selectEl: function (element) {
		var el = typeof element == 'string' ? document.querySelector('#' + element) : element;
		el.classList.toggle('for-del');
	},

	selectOneEl: function (element) {
		var el = typeof element == 'string' ? document.querySelector('#' + element) : element;
		this.unSelectAll();
		this.selectEl(el);
	},

	selectElsFromTo: function (first, last) {
		if (first == undefined) return;
		if (last == undefined) last = first;
		var allEl = this.getAllEl();
		this.unSelectAll();
		
		for (var i = first; i <= last; i++) {
			allEl[i].classList.add('for-del');
		}
	},

	checkForDel: function (check) {
		this.emit('check-for-del', check);
	}
}

function Form(el) {
	if (!el) return;
	this.events = new EventEmitter();
	this.el = el;
	this.btnAdd = this.el.querySelector('.add-btn');
	this.btnDel = this.el.querySelector('.del-btn');
	this.btnSelect = this.el.querySelector('.select-btn');
	this.input = this.el.querySelector('.input');
	this.init();
}


Form.prototype = {
	init: function() {
		this.el.addEventListener('click', this.delegationEventClick.bind(this));
		this.el.addEventListener('keyup', this.delegationEventKeyup.bind(this));
	},

	on: function (event, listener) {
		this.events.on(event, listener);
	},
	
	emit: function (event, parameters) {
		this.events.emit(event, parameters);
	},

	clearInputValue: function () {
		this.input.value = '';
	},

	delegationEventClick: function (e) {
		var target = e.target;

		if (target === this.btnAdd) {
			this.enterVal(this.input.value);
			this.clearInputValue();
		}

		if (target === this.btnSelect) {
			this.selectUnselectAll();
		}

		if (target === this.btnDel) {
			if (!confirm('Selected elements will be deleted. Are you sure?')) return;
			this.remove();
		}

		this.checkAddBtn();
	},

	delegationEventKeyup: function (e) {
		if (e.keyCode === 13 && this.input.value !== '') {
			this.enterVal(this.input.value);
			this.clearInputValue();
		}

		this.checkAddBtn();
	},

	enterVal: function (text) {
		this.emit('enter-value', text);
	},

	selectUnselectAll: function () {
		this.emit('select-unselect-all');
	},

	remove: function () {
		this.emit('remove-elements');
	},

	checkDelBtn: function (check) {
		check ? this.btnDel.removeAttribute('disabled') : this.btnDel.setAttribute('disabled', 'disabled');
	},

	checkAddBtn: function () {
		this.input.value === '' ? this.btnAdd.setAttribute('disabled', 'disabled') : this.btnAdd.removeAttribute('disabled');
	}
}
